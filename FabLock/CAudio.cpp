/* 
* CAudio.cpp
*
* Created: 07.01.2018 18:17:28
* Author: Marcel Jongmanns
*/

#include <avr/io.h>
#include <avr/pgmspace.h>
#include "CAudio.h"

// constants
const uint16_t freqLUT[64] PROGMEM = {
	0,
	369, // f = 55.0
	391, // f = 58.2704701898
	414, // f = 61.735412657
	438, // f = 65.4063913251
	465, // f = 69.2956577442
	492, // f = 73.4161919794
	521, // f = 77.7817459305
	553, // f = 82.4068892282
	585, // f = 87.3070578583
	620, // f = 92.4986056779
	657, // f = 97.9988589954
	696, // f = 103.826174395
	738, // f = 110.0
	782, // f = 116.54094038
	828, // f = 123.470825314
	877, // f = 130.81278265
	930, // f = 138.591315488
	985, // f = 146.832383959
	1043, // f = 155.563491861
	1106, // f = 164.813778456
	1171, // f = 174.614115717
	1241, // f = 184.997211356
	1315, // f = 195.997717991
	1393, // f = 207.65234879
	1476, // f = 220.0
	1564, // f = 233.081880759
	1657, // f = 246.941650628
	1755, // f = 261.625565301
	1860, // f = 277.182630977
	1970, // f = 293.664767917
	2087, // f = 311.126983722
	2212, // f = 329.627556913
	2343, // f = 349.228231433
	2482, // f = 369.994422712
	2630, // f = 391.995435982
	2787, // f = 415.30469758
	2952, // f = 440.0
	3128, // f = 466.163761518
	3314, // f = 493.883301256
	3511, // f = 523.251130601
	3720, // f = 554.365261954
	3941, // f = 587.329535835
	4175, // f = 622.253967444
	4424, // f = 659.255113826
	4687, // f = 698.456462866
	4965, // f = 739.988845423
	5261, // f = 783.990871963
	5574, // f = 830.60939516
	5905, // f = 880.0
	6256, // f = 932.327523036
	6628, // f = 987.766602512
	7022, // f = 1046.5022612
	7440, // f = 1108.73052391
	7883, // f = 1174.65907167
	8351, // f = 1244.50793489
	8848, // f = 1318.51022765
	9374, // f = 1396.91292573
	9931, // f = 1479.97769085
	10522, // f = 1567.98174393
	11148, // f = 1661.21879032
	11811, // f = 1760.0
	12513, // f = 1864.65504607
	13257, // f = 1975.53320502
};

const int8_t sineLUT[256] PROGMEM = {
	0, 3, 6, 9, 12, 15, 18, 21, 24, 28, 31, 34, 37, 40, 43, 46, 48, 51, 54, 57, 60, 63, 65, 68, 71, 73,
	76, 78, 81, 83, 85, 88, 90, 92, 94, 96, 98, 100, 102, 104, 106, 108, 109, 111, 112, 114, 115, 117, 118,
	119, 120, 121, 122, 123, 124, 124, 125, 126, 126, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127,
	126, 126, 125, 124, 124, 123, 122, 121, 120, 119, 118, 117, 115, 114, 112, 111, 109, 108, 106, 104, 102,
	100, 98, 96, 94, 92, 90, 88, 85, 83, 81, 78, 76, 73, 71, 68, 65, 63, 60, 57, 54, 51, 48, 46, 43, 40, 37,
	34, 31, 28, 24, 21, 18, 15, 12, 9, 6, 3, 0, -3, -6, -9, -12, -15, -18, -21, -24, -28, -31, -34, -37, -40, -43,
	-46, -48, -51, -54, -57, -60, -63, -65, -68, -71, -73, -76, -78, -81, -83, -85,
	-88, -90, -92, -94, -96, -98, -100, -102, -104, -106, -108, -109, -111, -112, -114, -115,
	-117, -118, -119, -120, -121, -122, -123, -124, -124, -125, -126, -126, -127, -127, -127, -127,
	-127, -128, -127, -127, -127, -127, -127, -126, -126, -125, -124, -124, -123, -122, -121, -120,
	-119, -118, -117, -115, -114, -112, -111, -109, -108, -106, -104, -102, -100, -98, -96, -94,
	-92, -90, -88, -85, -83, -81, -78, -76, -73, -71, -68, -65, -63, -60, -57, -54,
	-51, -48, -46, -43, -40, -37, -34, -31, -28, -24, -21, -18, -15, -12, -9, -6, -3,
};

// Yakety Sax - Key missing
const lied_t PROGMEM lied1[] = {
	{52, 4}, {49, 1}, {47, 3}, {40, 2}, {40, 2}, {37, 1}, {35, 3}, {49, 1}, {43, 2}, {40, 1}, {42, 2}, {40, 2}, {0, 4}, {47, 4}, {52, 2},
	{52, 2}, {49, 1}, {47, 1}, {44, 1}, {40, 1}, {47, 2}, {49, 2}, {47, 1}, {44, 1}, {40, 1}, {37, 1}, {40, 2}, {40, 1}, {42, 1}, {44, 1},
	{47, 1}, {49, 1}, {47, 1}, {52, 4}, {0, 1}, {47, 1}, {49, 1}, {51, 1}, {52, 2}, {52, 2}, {49, 1}, {47, 1}, {44, 1}, {40, 1}, {47, 2},
	{49, 2}, {47, 1}, {44, 1}, {40, 1}, {37, 1}, {47, 2}, {47, 1}, {49, 1}, {50, 1}, {51, 1}, {54, 1}, {51, 1}, {47, 4}, {0, 1}, {35, 1},
	{37, 1}, {39, 1}, {40, 2}, {40, 1}, {40, 1}, {40, 2}, {40, 1}, {40, 1}, {40, 2}, {40, 1}, {40, 1}, {37, 1}, {35, 1}, {32, 1}, {28, 1},
	{33, 2}, {33, 1}, {33, 1}, {33, 2}, {33, 1}, {33, 1}, {37, 2}, {40, 1}, {42, 1}, {43, 1}, {40, 2}, {42, 1}, {44, 1}, {43, 1}, {44, 1},
	{43, 1}, {44, 1}, {47, 2}, {43, 1}, {44, 1}, {47, 1}, {44, 1}, {42, 1}, {40, 1}, {37, 1}, {0, 2}, {49, 1}, {43, 2}, {40, 1}, {42, 2},
	{40, 2}, {0, 4}, {47, 4}, {52, 2}, {52, 2}, {49, 1}, {47, 1}, {44, 1}, {40, 1}, {47, 2}, {49, 2}, {47, 1}, {44, 1}, {40, 1}, {37, 1},
	{40, 2}, {40, 1}, {42, 1}, {44, 1}, {47, 1}, {49, 1}, {47, 1}, {52, 4}, {0, 1}, {47, 1}, {49, 1}, {51, 1}, {52, 2}, {52, 2}, {49, 1},
	{47, 1}, {44, 1}, {40, 1}, {47, 2}, {49, 2}, {47, 1}, {44, 1}, {40, 1}, {37, 1}, {47, 2}, {47, 1}, {49, 1}, {50, 1}, {51, 1}, {54, 1},
	{51, 1}, {47, 4}, {0, 1}, {35, 1}, {37, 1}, {39, 1}, {40, 2}, {40, 1}, {40, 1}, {40, 2}, {40, 1}, {40, 1}, {40, 2}, {40, 1}, {40, 1},
	{37, 1}, {35, 1}, {32, 1}, {28, 1}, {33, 2}, {33, 1}, {33, 1}, {33, 2}, {33, 1}, {33, 1}, {37, 2}, {40, 1}, {42, 1}, {43, 1}, {40, 2},
	{42, 1}, {44, 1}, {43, 1}, {44, 1}, {43, 1}, {44, 1}, {47, 2}, {43, 1}, {44, 1}, {47, 1}, {44, 1}, {42, 1}, {40, 1}, {37, 1}, {0, 2},
	{49, 1}, {43, 2}, {40, 1}, {42, 2}, {40, 2}, {0, 4}, {47, 4}, {0, 2}, {35, 1}, {35, 1}, {0, 2}, {40, 2}, {0, 2}, {35, 1}, {35, 1},
	{40, 2}, {41, 2}, {42, 12}, {42, 4}, {47, 2}, {46, 2}, {45, 1}, {46, 1}, {45, 1}, {46, 1}, {44, 2}, {42, 2}, {41, 2}, {42, 2}, {44, 2},
	{42, 2}, {41, 1}, {42, 1}, {41, 1}, {42, 1}, {40, 2}, {39, 2}, {38, 2}, {39, 2}, {42, 2}, {47, 2}, {44, 1}, {42, 1}, {40, 1}, {40, 1},
	{35, 2}, {37, 1}, {39, 1}, {42, 2}, {44, 2}, {42, 2}, {42, 1}, {44, 1}, {46, 1}, {49, 1}, {46, 2}, {42, 4}, {0, 4}, {35, 2}, {47, 2},
	{35, 2}, {47, 2}, {35, 2}, {47, 2}, {44, 1}, {42, 1}, {39, 1}, {37, 1}, {35, 2}, {47, 2}, {35, 2}, {47, 2}, {35, 2}, {47, 2}, {44, 1},
	{42, 1}, {38, 1}, {37, 1}, {35, 2}, {35, 1}, {37, 1}, {38, 1}, {39, 1}, {42, 2}, {37, 2}, {37, 1}, {39, 1}, {40, 1}, {42, 1}, {44, 1},
	{46, 1}, {47, 2}, {47, 2}, {44, 1}, {42, 1}, {39, 1}, {37, 1}, {35, 4}, {0, 2}, {47, 1}, {47, 1}, {44, 2}, {42, 2}, {39, 2}, {42, 2},
	{37, 1}, {39, 1}, {37, 1}, {35, 1}, {32, 2}, {30, 2}, {35, 2}, {35, 1}, {36, 1}, {39, 1}, {42, 2}, {39, 1}, {42, 2}, {44, 2}, {0, 2},
	{42, 2}, {47, 2}, {47, 2}, {44, 1}, {42, 1}, {39, 2}, {42, 2}, {44, 2}, {42, 1}, {39, 1}, {35, 2}, {42, 2}, {42, 1}, {44, 1}, {46, 1},
	{49, 1}, {46, 2}, {42, 4}, {0, 4}, {47, 2}, {47, 2}, {44, 1}, {42, 1}, {39, 1}, {37, 1}, {42, 2}, {42, 2}, {39, 1}, {37, 1}, {35, 1},
	{32, 1}, {38, 2}, {38, 2}, {40, 1}, {38, 1}, {35, 1}, {32, 1}, {41, 1}, {42, 1}, {41, 1}, {42, 1}, {40, 1}, {38, 1}, {35, 1}, {32, 1},
	{35, 2}, {35, 1}, {37, 1}, {38, 1}, {39, 1}, {40, 1}, {41, 1}, {42, 2}, {41, 1}, {42, 1}, {43, 1}, {44, 1}, {45, 1}, {46, 1}, {47, 2},
	{47, 2}, {44, 1}, {42, 1}, {39, 1}, {37, 1}, {35, 4}, {47, 4}, {52, 2}, {52, 2}, {49, 1}, {47, 1}, {44, 1}, {40, 1}, {47, 2}, {49, 2},
	{47, 1}, {44, 1}, {40, 1}, {37, 1}, {40, 2}, {40, 1}, {42, 1}, {44, 1}, {47, 1}, {49, 1}, {47, 1}, {52, 4}, {0, 1}, {47, 1}, {49, 1},
	{51, 1}, {52, 2}, {52, 2}, {49, 1}, {47, 1}, {44, 1}, {40, 1}, {47, 2}, {49, 2}, {47, 1}, {44, 1}, {40, 1}, {37, 1}, {47, 2}, {47, 1},
	{49, 1}, {50, 1}, {51, 1}, {54, 1}, {51, 1}, {47, 4}, {0, 1}, {35, 1}, {37, 1}, {39, 1}, {40, 2}, {40, 1}, {40, 1}, {40, 2}, {40, 1},
	{40, 1}, {40, 2}, {40, 1}, {40, 1}, {37, 1}, {35, 1}, {32, 1}, {28, 1}, {33, 2}, {33, 1}, {33, 1}, {33, 2}, {33, 1}, {33, 1}, {37, 2},
	{40, 1}, {42, 1}, {43, 1}, {40, 2}, {42, 1}, {44, 1}, {43, 1}, {44, 1}, {43, 1}, {44, 1}, {47, 2}, {43, 1}, {44, 1}, {47, 1}, {44, 1},
	{42, 1}, {40, 1}, {37, 1}, {0, 2}, {49, 1}, {43, 2}, {40, 1}, {42, 2}, {40, 2}, {0, 4}, {47, 4}, {52, 2}, {52, 2}, {49, 1}, {47, 1},
	{44, 1}, {40, 1}, {47, 2}, {49, 2}, {47, 1}, {44, 1}, {40, 1}, {37, 1}, {40, 2}, {40, 1}, {42, 1}, {44, 1}, {47, 1}, {49, 1}, {47, 1},
	{52, 4}, {0, 1}, {47, 1}, {49, 1}, {51, 1}, {52, 2}, {52, 2}, {49, 1}, {47, 1}, {44, 1}, {40, 1}, {47, 2}, {49, 2}, {47, 1}, {44, 1},
	{40, 1}, {37, 1}, {47, 2}, {47, 1}, {49, 1}, {50, 1}, {51, 1}, {54, 1}, {51, 1}, {47, 4}, {0, 1}, {35, 1}, {37, 1}, {39, 1}, {40, 2},
	{40, 1}, {40, 1}, {40, 2}, {40, 1}, {40, 1}, {40, 2}, {40, 1}, {40, 1}, {37, 1}, {35, 1}, {32, 1}, {28, 1}, {33, 2}, {33, 1}, {33, 1},
	{33, 2}, {33, 1}, {33, 1}, {37, 2}, {40, 1}, {42, 1}, {43, 1}, {40, 2}, {42, 1}, {44, 1}, {43, 1}, {44, 1}, {43, 1}, {44, 1}, {47, 2},
	{43, 1}, {44, 1}, {47, 1}, {44, 1}, {42, 1}, {40, 1}, {37, 1}, {0, 2}, {49, 1}, {43, 2}, {40, 1}, {42, 2}, {40, 2}, {47, 8}, {52, 2},
	{52, 2}, {49, 1}, {47, 3}, {40, 2}, {40, 2}, {37, 1}, {35, 3}, {49, 1}, {43, 2}, {40, 1}, {42, 2}, {40, 2}, {0, 2}, {35, 2}, {40, 4},
	{64, 0}};

// Spanish flea - window opening/closing
const lied_t PROGMEM lied2[] = {
	{40, 4}, {47, 4}, {35, 4}, {47, 2}, {47, 2}, {40, 4}, {47, 2}, {35, 2}, {35, 2}, {35, 2}, {47, 4}, {40, 4}, {47, 2}, {47, 2}, {35, 4},
	{47, 2}, {47, 2}, {40, 4}, {0, 4}, {0, 2}, {32, 2}, {33, 2}, {34, 2}, {35, 4}, {44, 2}, {35, 2}, {44, 2}, {42, 2}, {0, 2}, {41, 10},
	{0, 2}, {37, 2}, {36, 2}, {35, 2}, {34, 4}, {42, 2}, {34, 2}, {42, 2}, {40, 2}, {0, 2}, {39, 10}, {0, 2}, {35, 2},
	{34, 2}, {33, 2}, {32, 2}, {35, 2}, {40, 2}, {37, 2}, {0, 2}, {40, 2}, {42, 4}, {35, 2}, {38, 2}, {43, 2}, {40, 2}, {0, 2}, {43, 2},
	{45, 4}, {47, 16}, {47, 2}, {0, 2}, {47, 2}, {47, 2}, {49, 2}, {47, 2}, {43, 1}, {42, 3}, {40, 4}, {44, 2}, {35, 2}, {44, 2}, {42, 2},
	{0, 2}, {41, 2}, {41, 8}, {0, 2}, {37, 2}, {36, 2}, {35, 2}, {34, 4}, {42, 2}, {34, 2}, {42, 2}, {40, 2}, {0, 2}, {39, 10},
	{0, 2}, {35, 2}, {34, 2}, {33, 2}, {32, 2}, {35, 2}, {40, 2}, {37, 2}, {0, 2}, {40, 2}, {42, 4}, {35, 2}, {38, 2}, {43, 2}, {40, 2},
	{0, 2}, {43, 2}, {45, 4}, {47, 16}, {0, 4}, {47, 2}, {47, 2}, {49, 2}, {47, 2}, {43, 1}, {42, 3}, {40, 4}, {0, 4}, {35, 4}, {47, 2},
	{47, 2}, {40, 4}, {47, 2}, {35, 2}, {35, 2}, {35, 2}, {47, 4}, {40, 4}, {47, 2}, {47, 2}, {35, 4}, {47, 2}, {47, 2}, {0, 4}, {40, 4},
	{42, 4}, {44, 4}, {45, 4}, {0, 4}, {0, 2}, {45, 2}, {47, 2}, {45, 2}, {49, 2}, {47, 2}, {0, 2}, {45, 2}, {0, 2}, {43, 2}, {42, 2},
	{40, 2}, {38, 8}, {40, 2}, {41, 2}, {0, 2}, {42, 6}, {0, 4}, {0, 2}, {38, 2}, {37, 2}, {36, 2}, {35, 4}, {43, 2},
	{43, 2}, {0, 2}, {43, 2}, {45, 2}, {43, 2}, {47, 2}, {45, 4}, {43, 2}, {0, 2}, {41, 2}, {40, 2}, {38, 2}, {36, 4}, {36, 4}, {38, 2},
	{40, 6}, {39, 2}, {40, 2}, {0, 2}, {42, 18}, {0, 2}, {32, 2}, {33, 2}, {34, 2}, {35, 4}, {44, 2}, {35, 2}, {44, 2},
	{42, 2}, {0, 2}, {41, 2}, {41, 8}, {0, 2}, {37, 2}, {36, 2}, {35, 2}, {34, 4}, {42, 2}, {34, 2}, {42, 2}, {40, 2}, {0, 2}, {39, 2},
	{39, 8}, {0, 2}, {35, 2}, {34, 2}, {33, 2}, {32, 2}, {35, 2}, {40, 2}, {37, 2}, {0, 2}, {40, 2}, {42, 4}, {35, 2}, {38, 2}, {43, 2},
	{40, 2}, {0, 2}, {43, 2}, {45, 4}, {47, 16}, {0, 4}, {47, 2}, {47, 2}, {49, 2}, {47, 2}, {43, 1}, {42, 3}, {40, 4}, {0, 4}, {35, 4},
	{47, 2}, {47, 2}, {40, 4}, {47, 2}, {35, 2}, {35, 2}, {35, 2}, {47, 4}, {40, 4}, {47, 2}, {47, 2}, {35, 4}, {47, 2}, {47, 2}, {0, 4},
	{40, 4}, {42, 4}, {44, 4}, {45, 4}, {0, 4}, {0, 2}, {45, 2}, {47, 2}, {45, 2}, {49, 2}, {47, 2}, {0, 2}, {45, 2}, {0, 2}, {43, 2},
	{42, 2}, {40, 2}, {0, 4}, {38, 4}, {0, 4}, {0, 2}, {42, 2}, {38, 4}, {40, 2}, {41, 2}, {42, 4}, {0, 4}, {0, 8}, {35, 4}, {43, 2},
	{43, 2}, {0, 2}, {43, 2}, {45, 2}, {43, 2}, {47, 2}, {45, 4}, {43, 2}, {0, 2}, {41, 2}, {40, 2}, {38, 2}, {36, 4}, {36, 4}, {38, 2},
	{40, 6}, {39, 2}, {40, 2}, {0, 2}, {42, 18}, {0, 2}, {32, 2}, {33, 2}, {34, 2}, {35, 4}, {44, 2}, {35, 2}, {44, 2},
	{42, 2}, {0, 2}, {41, 2}, {41, 8}, {0, 2}, {37, 2}, {36, 2}, {35, 2}, {34, 4}, {42, 2}, {34, 2}, {42, 2}, {40, 2}, {0, 2}, {39, 2},
	{39, 8}, {0, 2}, {35, 2}, {34, 2}, {33, 2}, {32, 2}, {35, 2}, {40, 2}, {37, 2}, {0, 2}, {40, 2}, {42, 4}, {35, 2}, {38, 2}, {43, 2},
	{40, 2}, {0, 2}, {43, 2}, {45, 4}, {47, 16}, {0, 4}, {47, 2}, {47, 2}, {49, 2}, {47, 2}, {43, 1}, {42, 3}, {40, 4}, {0, 4}, {0, 8},
	{0, 16},
	{64, 0}};

		
enum note {
	nPAUSE = 0, nA1, nAis1, nB1,
	nC2, nCis2, nD2, nDis2, nE2, nF2, nFis2, nG2, nGis2, nA2, nAis2, nB2,
	nC3, nCis3, nD3, nDis3, nE3, nF3, nFis3, nG3, nGis3, nA3, nAis3, nB3,
	nC4, nCis4, nD4, nDis4, nE4, nF4, nFis4, nG4, nGis4, nA4, nAis4, nB4,
	nC5, nCis5, nD5, nDis5, nE5, nF5, nFis5, nG5, nGis5, nA5, nAis5, nB5,
	nC6, nCis6, nD6, nDis6, nE6, nF6, nFis6, nG6, nGis6, nA6, nAis6, nB6,
	nENDE
};

// default constructor
CAudio::CAudio()
{
	this->phase = 0;
	this->frequency = 0;
	this->isPlaying = 0;
	this->pos = 0;
	this->song = 0;
} //CAudio

// default destructor
CAudio::~CAudio()
{
} //~CAudio

void CAudio::init()
{
	// Timer 1 -> 9.6kHz samplerate
	TCCR1A = 0;
	TCCR1B = _BV(WGM12) | _BV(CS00);
	OCR1A = 833;
	TIMSK1 = _BV(OCIE1A);
	
	// Timer 2 -> PWM
	TCCR2A = _BV(COM2B1) | _BV(WGM21) | _BV(WGM20);
	TCCR2B = _BV(CS20);
	OCR2B = 0x80;
}

void CAudio::start(uint8_t freq)
{
	if(freq < nENDE)
	{
		this->frequency = pgm_read_word(&freqLUT[freq]);
	}
	else
	{
		this->frequency = 0;
	}
}

void CAudio::stop()
{
	this->frequency = 0;
	OCR2B = 0x80;
}

void CAudio::onTimer()
{
	int8_t amp;
	
	this->phase += this->frequency;
	amp = (int8_t)pgm_read_byte(&sineLUT[this->phase >> 8]);
	
	if(this->frequency)
	{
		OCR2B = ((uint16_t)0x200 + amp) >> 2;
	}
	else
	{
		//OCR2B = 0x80;
	}
}

void CAudio::stopSong()
{
	this->isPlaying = 0;
	this->frequency = 0;
	OCR2B = 0x80;
}

void CAudio::playSong1()
{
	if(this->isPlaying)
	{
		return;
	}
	
	this->pos = 0;
	this->len = 0;
	this->isPlaying = 1;
	this->song = lied1;
}

void CAudio::playSong2()
{
	if(this->isPlaying)
	{
		return;
	}
	
	this->pos = 0;
	this->len = 0;
	this->isPlaying = 1;
	this->song = lied2;
}

void CAudio::step()
{
	static uint8_t wasSpacing = 0;
	uint8_t note;
	
	// return is not playing
	if(!this->isPlaying || this->song == 0)
	{
		return;
	}
	
	if(!this->len)
	{
		// create pause between notes
		if(!wasSpacing)
		{
			this->frequency = 0;
			this->len = 1;
			wasSpacing = 1;
			return;
		}
		
		note = pgm_read_byte(&this->song[this->pos].n);
		
		// song over -> repeat
		if(note >= nENDE)
		{
			this->pos = 0;
			this->frequency = 0;
			this->len = 1;
			return;
		}
		
		this->frequency = pgm_read_word(&freqLUT[note]);
		this->len = pgm_read_word(&this->song[this->pos].l);
		wasSpacing = 0;
		
		this->pos++;
	}
	else
	{
		this->len--;
	}
}